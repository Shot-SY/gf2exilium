<!DOCTYPE html>
<html lang="ko"> <!-- 언어 설정 변경 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소녀전선 2: 망명</title> <!-- 타이틀 한글화 -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Noto Sans KR 폰트 추가 (선택 사항, 한국어 가독성 향상) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6Y21MLG0SJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6Y21MLG0SJ');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
    <style>
        body {
            /* 기본 폰트를 Noto Sans KR로 변경, Roboto는 fallback */
            font-family: 'Noto Sans KR', 'Roboto', sans-serif;
            background-color: #121212;
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            color: #e0e0e0;
            position: relative;
            overflow-y: scroll;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Poppins', sans-serif; /* 제목 폰트는 유지 */
            font-size: 2.5em;
            color: #ff4081;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.2);
            position: relative;
            z-index: 1;
        }
        /* --- 나머지 CSS 스타일은 변경 없음 --- */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            transform: translateZ(0);
            contain: layout paint;
        }
        .character-box {
            background: url('https://www.transparenttextures.com/patterns/gplay.png'), rgba(26,26,26,0.2);
            background-repeat: repeat;
            background-size: cover;
            border: none;
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
            position: relative;
            height: 160px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1;
            transform: translateZ(0);
            contain: layout paint;
        }
        .character-box.rare {
            border: 2px solid #ff9800;
            box-shadow: 0 4px 12px rgba(255,152,0,0.7);
        }
        .character-box.selected {
            background-color: rgba(255,64,129,0.9);
            box-shadow: 0 8px 20px rgba(255,64,129,0.8);
            transform: translateY(-5px);
        }
        @media (hover: hover) and (pointer: fine) {
            .character-box:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255,255,255,0.2);
            }
            .character-box:hover .character-img {
                transform: rotate(5deg);
            }
            #filterButton:hover {
                background: linear-gradient(45deg, #ff4081, #f50057);
                box-shadow: 0 6px 20px rgba(255,64,129,0.8);
                transform: translateY(-3px);
            }
            .result-item:hover {
                background-color: #1e1e1e;
                box-shadow: 0 4px 12px rgba(255,64,129,0.4);
            }
        }
        .character-img {
            width: 80px;
            height: 90px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 10px;
            transition: transform 0.3s;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        .character-name {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 700;
            color: #fff;
            /* 한국어 이름이 길 경우 줄바꿈 허용 */
            word-break: keep-all;
            overflow-wrap: break-word;
        }
        .spinbox-container {
            width: 80%;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s, transform 0.3s;
            justify-content: center;
            margin-top: -5px;
            transform: translateY(-10px);
        }
        .character-box.selected .spinbox-container {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .spinbox-container input[type="number"] {
            width: 50px;
            padding: 5px;
            border: 1px solid #555;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            transition: border-color 0.3s, box-shadow 0.3s;
            /* 스피너 버튼 숨기기 (선택사항) */
            -moz-appearance: textfield;
        }
        .spinbox-container input[type="number"]::-webkit-outer-spin-button,
        .spinbox-container input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .spinbox-container input[type="number"]:focus {
            border-color: #ff4081;
            box-shadow: 0 0 5px rgba(255,64,129,0.5);
            outline: none;
            background-color: #2a2a2a;
        }
        #filterButton {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            margin: 25px 0;
            font-size: 18px;
            cursor: pointer;
            background: linear-gradient(45deg, #ff4081, #f50057);
            color: #fff;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 16px rgba(255,64,129,0.6);
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif; /* 폰트 적용 */
            font-weight: 600;
            position: relative;
            z-index: 1;
            transform: translateZ(0);
        }
        #filterButton:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(255,64,129,0.6);
        }
        #copyInstruction {
            margin-bottom: 15px;
            font-style: italic;
            color: #ff4081;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        #copyMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            display: none;
            opacity: 0;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif; /* 폰트 적용 */
            font-size: 1.1em;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-left: 4px solid #ff4081;
            will-change: transform, opacity;
        }

        #copyMessage.show {
            display: flex;
            align-items: center;
            gap: 15px;
            animation: messagePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes messagePop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        /* 복사 아이콘 */
        .copy-icon {
            width: 24px;
            height: 24px;
            background-color: #ff4081;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
            transform: translateZ(0);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 64, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0); }
        }

        .copy-icon svg {
            width: 14px;
            height: 14px;
            fill: white;
            transform: translateZ(0);
        }

        #results {
            padding: 20px;
            height: 800px;
            max-height: 800px;
            overflow-y: auto;
            background-color: rgba(26,26,26,0.8);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(255,255,255,0.1);
            position: relative;
            z-index: 1;
            will-change: scroll-position;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            contain: strict;
            transform: translateZ(0);
        }
        #results .content-container {
            transform: translateZ(0);
            will-change: opacity;
            transition: opacity 0.2s ease;
            contain: layout paint style;
            backface-visibility: hidden;
        }

        #results.filtering .content-container {
            opacity: 0;
        }

        /* 스크롤 최적화 스타일 */
        #results.scrolling .result-item {
            transition: none !important;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(42,42,42,0.8);
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(255,64,129,0.2);
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateZ(0);
            contain: layout paint;
        }
        .small-character-img {
            width: auto;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
            transform: translateZ(0);
            backface-visibility: hidden;
            contain: paint;
        }
        .small-character-img.rare {
            border: 2px solid #ff9800;
            box-shadow: 0 2px 8px rgba(255,152,0,0.7);
        }
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/geometry-dark.png') repeat;
            opacity: 0.04;
            z-index: -1;
        }
        .character-box::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/gplay.png') repeat;
            opacity: 0.2;
            border-radius: 15px;
            pointer-events: none;
            z-index: 0;
        }
        .character-box > * {
            position: relative;
            z-index: 1;
        }
        .result-text {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            transform: translateZ(0);
        }
        .result-text .item {
            color: #fff;
            font-weight: 700;
            /* 긴 텍스트 줄바꿈 처리 */
            word-break: break-all;
            overflow-wrap: break-word;
        }
        .result-text .price {
            color: #00e676;
            font-weight: 600;
            white-space: nowrap; /* 가격 줄바꿈 방지 */
        }
        .result-text .key {
            color: orange;
            font-weight: 500;
            font-size: 0.9em; /* 키값 폰트 약간 작게 */
            white-space: nowrap;
        }
        .result-text .count {
            color: #ff9800;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .character-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px,1fr));
                gap: 15px;
            }
            .character-box {
                height: 140px;
                padding: 10px;
            }
            .spinbox-container input[type="number"] {
                width: 45px;
            }
            #filterButton {
                font-size: 16px;
                padding: 12px;
            }
            .result-item {
                padding: 12px;
            }
            .small-character-img {
                /* 모바일에서 이미지 크기 약간 줄임 */
                height: 60px;
            }
            .result-text {
                gap: 5px;
            }
            #copyInstruction {
                font-size: 1em;
            }
            #copyMessage {
                font-size: 1em;
                padding: 15px 20px;
            }
            /* 모바일에서 아이템 박스 크기 조정 */
            .item-box {
                 width: 47px;
                 height: 47px;
            }
            .item-title {
                 font-size: 11px; /* 모바일 폰트 크기 조정 */
            }
            .item-count {
                 font-size: 9px; /* 모바일 폰트 크기 조정 */
            }
        }
        #tsparticles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18,18,18,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #loader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #ff4081;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            transform: translateZ(0);
        }
        .item-images {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            transform: translateZ(0);
            contain: layout paint;
            gap: 5px; /* 아이템 이미지/박스 간 간격 추가 */
        }
        .item-box {
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 62px; /* 크기 유지 또는 필요시 조정 */
            height: 62px;
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-radius: 10px;
            /* margin 제거 (gap으로 대체) */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateZ(0);
            contain: layout paint;
            text-align: center; /* 텍스트 중앙 정렬 */
        }
        .item-title {
            color: #ff4081;
            font-size: 12px; /* 폰트 크기 조정 */
            font-weight: bold;
            margin-bottom: 2px; /* 간격 조정 */
            line-height: 1.2; /* 줄 간격 조정 */
        }
        .item-count {
            color: #fff;
            font-size: 10px; /* 폰트 크기 조정 */
            font-weight: 500;
            line-height: 1.2;
            word-break: keep-all; /* 한국어 단어 유지 */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        @keyframes fadeOutScale {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* 팝업 스타일 */
        .signature-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: rgba(18, 18, 18, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            padding: 20px;
            z-index: 2000;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            will-change: transform, opacity;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .signature-popup.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .signature-popup-title {
            color: #ff4081;
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            /* 한국어 줄바꿈 처리 */
            word-break: keep-all;
            overflow-wrap: break-word;
        }

        .signature-popup-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: translateZ(0);
            contain: content;
        }

        .signature-popup-item {
            background-color: rgba(42, 42, 42, 0.8);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            display: flex;
            flex-direction: column;
            transform: translateZ(0);
            contain: layout paint;
        }

        .signature-popup-item:hover {
            background-color: rgba(64, 64, 64, 0.8);
            transform: translateY(-3px);
        }

        .signature-popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 1;
        }

        .signature-popup-close:hover {
            color: #ff4081;
        }

        /* 오버레이 스타일 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1999; /* 팝업보다 낮고 다른 요소보다 높은 z-index */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            will-change: opacity;
        }

        .overlay.show {
            display: block;
            opacity: 1;
        }

        /* 스크롤 중 팝업 최적화 */
        .signature-popup.scrolling .signature-popup-item {
            transition: none !important;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <!-- 로딩 메시지 추가 (선택사항) -->
        <p style="color: #e0e0e0; margin-top: 10px;">데이터 로딩 중...</p>
    </div>
    <div id="tsparticles"></div>
    <h1>소녀전선 2: 망명</h1> <!-- 제목 한글화 -->
    <div class="character-grid" id="characterGrid"></div>
    <button id="filterButton">필터 적용</button> <!-- 버튼 텍스트 한글화 -->
    <div id="copyInstruction">※ 아이템을 클릭하면 유사 아이템 목록을 보거나 내용을 복사합니다</div> <!-- 설명 한글화 -->
    <div id="results"></div>
    <div id="copyMessage">
        <div class="copy-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
        </div>
        <span>복사됨</span> <!-- 메시지 한글화 -->
    </div>

    <!-- 오버레이 요소 -->
    <div id="overlay" class="overlay"></div>

    <!-- 시그니처 팝업 -->
    <div id="signaturePopup" class="signature-popup">
        <button class="signature-popup-close" id="signaturePopupClose">×</button>
        <!-- 팝업 제목은 JS에서 동적으로 설정됨 -->
        <div class="signature-popup-title">동일 구성 아이템</div> <!-- 기본 제목 한글화 -->
        <div class="signature-popup-items" id="signaturePopupItems"></div>
    </div>

    <script>
        // --- 기존 JS 코드 시작 ---
        let lastActivityTime = Date.now();
        const updateActivityTime = () => {
            lastActivityTime = Date.now();
        };
        ['click', 'touchstart', 'scroll', 'keypress'].forEach(event => {
            document.addEventListener(event, updateActivityTime);
        });
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                const currentTime = Date.now();
                const inactiveTime = currentTime - lastActivityTime;
                const twoHours = 7200000;
                if (inactiveTime > twoHours) {
                    window.location.reload(true);
                } else {
                    lastActivityTime = currentTime;
                }
            }
        });

        window.addEventListener('load', () => {
            const lastLoad = localStorage.getItem('lastLoadTime');
            const currentTime = Date.now();

            if (!lastLoad || (currentTime - parseInt(lastLoad)) > 1000) {
                localStorage.setItem('lastLoadTime', currentTime);
                window.location.reload(true);
                return;
            }

            const loader = document.getElementById('loader');
            loadCharacters()
                .then(() => loadData())
                .then(() => filterData())
                .then(() => new Promise(r => setTimeout(r, 500)))
                .then(() => {
                    loader.classList.add('hidden');
                    setTimeout(() => {
                        loader.style.display = 'none';

                        const results = document.getElementById('results');
                        if (results) {
                            results.style.willChange = 'scroll-position';
                            results.style.webkitOverflowScrolling = 'touch';
                            results.style.overscrollBehavior = 'contain';
                            results.style.contain = 'strict';

                            let lastScrollTime = 0;
                            const scrollThreshold = 16;

                            results.addEventListener('scroll', function(e) {
                                const now = performance.now();
                                if (now - lastScrollTime >= scrollThreshold) {
                                    lastScrollTime = now;
                                    if (!results.isScrolling) {
                                        results.isScrolling = true;
                                        results.classList.add('scrolling');
                                        document.body.classList.add('is-scrolling');
                                    }
                                    clearTimeout(results.scrollEndTimer);
                                    results.scrollEndTimer = setTimeout(function() {
                                        results.isScrolling = false;
                                        results.classList.remove('scrolling');
                                        document.body.classList.remove('is-scrolling');
                                    }, 100);
                                }
                            }, { passive: true });

                            results.addEventListener('touchstart', function() {
                                results.classList.add('scrolling');
                                document.body.classList.add('is-scrolling');
                            }, { passive: true });

                            results.addEventListener('touchend', function() {
                                setTimeout(function() {
                                    results.classList.remove('scrolling');
                                    document.body.classList.remove('is-scrolling');
                                }, 100);
                            }, { passive: true });
                        }

                        const signaturePopup = document.getElementById('signaturePopup');
                        if (signaturePopup) {
                            let lastPopupScrollTime = 0;
                            const popupScrollThreshold = 16;
                            signaturePopup.addEventListener('scroll', function(e) {
                                const now = performance.now();
                                if (now - lastPopupScrollTime >= popupScrollThreshold) {
                                    lastPopupScrollTime = now;
                                    if (!signaturePopup.isScrolling) {
                                        signaturePopup.isScrolling = true;
                                        signaturePopup.classList.add('scrolling');
                                    }
                                    clearTimeout(signaturePopup.scrollEndTimer);
                                    signaturePopup.scrollEndTimer = setTimeout(function() {
                                        signaturePopup.isScrolling = false;
                                        signaturePopup.classList.remove('scrolling');
                                    }, 100);
                                }
                            }, { passive: true });
                        }

                        optimizeImages();
                        optimizeParticles();
                    }, 500);
                })
                .catch(error => {
                    console.error('초기 필터 적용 에러:', error);
                    // 오류 메시지 표시 (선택사항)
                    document.getElementById('results').innerHTML = '<p style="color: red; text-align: center;">데이터 로딩 또는 필터링 중 오류가 발생했습니다. 페이지를 새로고침해주세요.</p>';
                    loader.classList.add('hidden');
                    setTimeout(() => loader.style.display = 'none', 500);
                });
        });

        tsParticles.load("tsparticles", {
            particles: {
                number: { value: 50, density: { enable: true, value_area: 800 }},
                shape: { type: "star", stroke: { width: 0, color: "#fff" }},
                size: { value: 3, random: { enable: true, minimumValue: 1 }},
                move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out" },
                color: { value: ["#FF0000","#FF7F00","#FFFF00","#00FF00","#0000FF","#4B0082","#8F00FF"] },
                opacity: { value: 0.8, random: false }
            },
            interactivity: { events: { onhover: { enable: false }, onclick: { enable: false } }},
            retina_detect: true
        });

        function optimizeParticles() {
            const pauseParticles = () => {
                if (window.tsParticles && window.tsParticles.domItem(0)) {
                    window.tsParticles.domItem(0).pause();
                }
            };
            const resumeParticles = () => {
                if (window.tsParticles && window.tsParticles.domItem(0)) {
                    window.tsParticles.domItem(0).play();
                }
            };
            const results = document.getElementById('results');
            if (results) {
                results.addEventListener('scroll', () => {
                    if (!results.particlesPaused) {
                        pauseParticles();
                        results.particlesPaused = true;
                        clearTimeout(results.particlesTimer);
                        results.particlesTimer = setTimeout(() => {
                            resumeParticles();
                            results.particlesPaused = false;
                        }, 200);
                    }
                }, { passive: true });
                results.addEventListener('touchstart', () => {
                    if (!results.particlesPaused) {
                        pauseParticles();
                        results.particlesPaused = true;
                    }
                }, { passive: true });
                results.addEventListener('touchend', () => {
                    clearTimeout(results.particlesTimer);
                    results.particlesTimer = setTimeout(() => {
                        resumeParticles();
                        results.particlesPaused = false;
                    }, 200);
                }, { passive: true });
            }
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    pauseParticles();
                } else {
                    resumeParticles();
                }
            });
        }

        let characters = [];
        let rareCharacters = [];

        function loadCharacters() {
            const ts = new Date().getTime();
            return fetch(`Characters.txt?t=${ts}`)
                .then(r => r.text())
                .then(text => {
                    characters = [];
                    rareCharacters = [];
                    let foundSabrina = false;
                    text.split('\n').forEach(line => {
                        const parts = line.trim().split(' ');
                        if (parts.length >= 2) {
                            const eng = parts[0];
                            const kor = parts.slice(1).join(' ');
                            if (eng === 'sabrina' && kor === '사브리나') {
                                foundSabrina = true;
                            }
                            if (eng && kor) {
                                characters.push([eng, kor]);
                                if (!foundSabrina) {
                                    rareCharacters.push([eng, kor]);
                                }
                            }
                        }
                    });
                    createCharacterBoxes(); // 데이터 로드 후 박스 생성 호출
                })
                .catch(error => {
                    console.error('캐릭터 데이터 로딩 오류:', error);
                    // 사용자에게 오류 알림 (선택사항)
                    document.getElementById('characterGrid').innerHTML = '<p style="color: red; text-align: center;">캐릭터 정보를 불러오는 데 실패했습니다.</p>';
                    throw error; // 오류를 전파하여 로딩 프로세스 중단
                });
        }

        let luaData = {};
        const characterGrid = document.getElementById('characterGrid');

        function createCharacterBoxes() {
            const characterGrid = document.getElementById('characterGrid');
            characterGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            characters.forEach(([eng, kor]) => {
                const charBox = document.createElement('div');
                charBox.className = 'character-box';
                charBox.dataset.engName = eng;
                charBox.dataset.korName = kor; // 한국어 이름도 데이터 속성으로 저장

                if (rareCharacters.some(([rareEng]) => rareEng === eng)) {
                    charBox.classList.add('rare');
                }

                const img = document.createElement('img');
                img.src = `Portrait/${kor}.png`;
                img.alt = kor; // Alt 텍스트는 한국어 이름 사용
                img.className = 'character-img';
                img.loading = 'lazy';
                img.decoding = 'async';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'character-name';
                nameSpan.textContent = kor; // *** 이름 표기를 한국어로 변경 ***

                const spinboxContainer = document.createElement('div');
                spinboxContainer.className = 'spinbox-container';

                const spinbox = document.createElement('input');
                spinbox.type = 'number';
                spinbox.id = `${eng}-spin`; // ID는 영어 이름 유지 (JS 로직 의존성)
                spinbox.min = 0;
                spinbox.max = 8;
                spinbox.value = 0;
                spinbox.disabled = true;
                spinbox.setAttribute('aria-label', `${kor} 개수`); // 접근성 레이블 추가

                spinboxContainer.appendChild(spinbox);
                charBox.append(img, nameSpan, spinboxContainer);
                fragment.appendChild(charBox);

                charBox.addEventListener('click', (e) => {
                    if(e.target.tagName.toLowerCase() !== 'input') toggleSelection(charBox);
                });

                spinbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(!charBox.classList.contains('selected')) {
                        toggleSelection(charBox); // 선택 로직 통합
                    }
                });
                // 스핀박스 값 변경 시 필터링 버튼 활성화 등 (선택적 기능)
                // spinbox.addEventListener('change', () => { /* 필요한 로직 추가 */ });
            });

            characterGrid.appendChild(fragment);
        }

        function toggleSelection(charBox) {
            const spinbox = charBox.querySelector('input[type="number"]');
            const isSelected = charBox.classList.toggle('selected');
            spinbox.disabled = !isSelected;
            if (isSelected) {
                // 선택될 때: 값이 0이면 1로, 아니면 그대로 유지
                if (spinbox.value === '0') {
                    spinbox.value = '1';
                }
            } else {
                // 선택 해제될 때: 값을 0으로 초기화
                spinbox.value = 0;
            }
        }


        function filterValidCharacters(charString) {
            // 이 함수는 현재 사용되지 않는 것으로 보임, 필요시 로직 검토
            const validCharCodes = new Set(characters.map(([eng]) => eng.slice(0, 2)));
            const charGroups = charString.match(/.{1,3}/g) || [];
            const validGroups = charGroups.filter(group => {
                const code = group.slice(0, 2);
                return validCharCodes.has(code);
            });
            return validGroups.join('');
        }

        let itemDetailsMap = {};

        function loadData() {
            const ts = new Date().getTime();
            return fetch(`sorted_data_eng.txt?t=${ts}`) // 파일명 확인 필요 (영어 버전 데이터 사용)
                .then(r => r.text())
                .then(text => {
                    luaData = {};
                    itemDetailsMap = {};
                    const lines = text.split('\n');
                    let currentSection = null;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('===') && line.endsWith('===')) {
                            currentSection = line.slice(4, -4).trim();
                            continue;
                        }
                        if (line && !line.startsWith('===') && currentSection !== null) {
                            const parts = line.split(' ');
                            if (parts.length < 2) continue;

                            const key = parts[0];
                            let charString = '';
                            let j = 1;
                            let itemDetails = {
                                originalText: line, // 원본 텍스트 저장 (복사용)
                                price: 0,
                                guaranteed: line.toLowerCase().includes('guaranteed'), // 대소문자 무시
                                displayText: '',
                                gemsCount: null,
                                gemsText: null
                            };

                            const priceMatch = line.match(/\$(\d+(\.\d+)?)/); // 정수 가격도 고려
                            if (priceMatch) {
                                itemDetails.price = parseFloat(priceMatch[1]);
                            }

                            // 캐릭터 정보 추출 개선 (suomi1 형태 처리)
                            while (j < parts.length) {
                                const part = parts[j];
                                const charMatch = part.match(/^([a-z]+)(\d+)$/i);
                                if (charMatch) {
                                    const charName = charMatch[1].toLowerCase();
                                    const count = charMatch[2];
                                     // characters 배열에서 eng 이름이 일치하는지 확인
                                    if (characters.some(([eng]) => eng === charName)) {
                                        charString += charName.slice(0, 2) + count;
                                    } else {
                                        // 캐릭터 목록에 없는 경우, 루프를 멈추거나 다른 처리
                                        break;
                                    }
                                } else {
                                    // 숫자나 다른 패턴이 나오면 캐릭터 정보 종료
                                    break;
                                }
                                j++;
                            }


                            // Gems 부분 찾기 (PickupTicket 또는 다른 형태 고려)
                            // 예: "10 PickupTicket", "PickupTicket 10" 등 다양한 형태 가능
                            const gemsMatch = line.match(/(\d+)\s*(PickupTicket|PTicket)/i) || line.match(/(PickupTicket|PTicket)\s*(\d+)/i);
                            if (gemsMatch) {
                                itemDetails.gemsCount = gemsMatch[1] || gemsMatch[2]; // 숫자가 오는 위치에 따라 인덱스 조정
                                itemDetails.gemsText = `${itemDetails.gemsCount} ${gemsMatch[2]||gemsMatch[1]}`; // 재구성
                            }

                            // 표시 텍스트 설정 (키와 = 제거, 공백 정리)
                            itemDetails.displayText = line.replace(key, '').replace('=', '').replace(/\$\d+(\.\d+)?/, '').replace(/(\d+)\s*(PickupTicket|PTicket)/i, '').replace(/(PickupTicket|PTicket)\s*(\d+)/i, '').replace(/guaranteed/i,'').trim().replace(/\s+/g, ' '); // 중복 공백 제거


                            if (charString) {
                                luaData[key] = charString;
                                itemDetailsMap[key] = itemDetails;
                            }
                        }
                    }

                }).catch(error => {
                    console.error('데이터 로딩 오류:', error);
                    document.getElementById('results').innerHTML = '<p style="color: red; text-align: center;">아이템 데이터를 불러오는 데 실패했습니다.</p>';
                    throw error;
                });
        }

		function generateRareSignature(charString) {
			const chars = charString.match(/.{1,3}/g) || [];
			let signature = {};
			const excludedRareCodes = ['gy', 'to']; // 경구(gyunggu), 토로로(tororo) 제외

			chars.forEach(char => {
				const code = char.slice(0, 2);
				const count = parseInt(char[2]);

                // rareCharacters 배열 ([eng, kor])에서 eng 이름의 앞 두 글자가 코드와 일치하는지 확인
				const isGenerallyRare = rareCharacters.some(([eng]) => eng.slice(0, 2) === code);
				const isExcluded = excludedRareCodes.includes(code);

				if (isGenerallyRare && !isExcluded) {
					signature[code] = (signature[code] || 0) + count;
				}
			});

			return Object.entries(signature)
				.sort((a, b) => a[0].localeCompare(b[0]))
				.map(([code, count]) => `${code}${count}`)
				.join('');
		}

        function filterData() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('filtering');

            // 필터링 시작 시 로딩 상태 표시 (선택사항)
            // resultsDiv.innerHTML = '<div class="spinner" style="margin: 50px auto;"></div>';

            if (window.tsParticles && window.tsParticles.domItem(0)) {
                window.tsParticles.domItem(0).pause();
            }

            // 비동기 처리를 위해 setTimeout 사용 (UI 블로킹 방지)
            setTimeout(() => {
                try {
                    let filtered = {};
                    for(const [k, v] of Object.entries(luaData)) {
                        const chars = v.match(/.{1,3}/g)||[];
                        if(checkConditions(chars)) filtered[k] = v;
                    }

                    const sortedKeys = Object.keys(filtered).sort((a, b) => {
                        // 가격 내림차순 정렬
                        return (itemDetailsMap[b]?.price ?? 0) - (itemDetailsMap[a]?.price ?? 0);
                    });

                    const final = {};
                    sortedKeys.forEach(key => {
                        final[key] = filtered[key];
                        // 레어 시그니처 계산 (null 체크 추가)
                        if (itemDetailsMap[key]) {
                           itemDetailsMap[key].rareSignature = generateRareSignature(final[key]);
                        }
                    });

                    displayResults(final);

                } catch (error) {
                    console.error("필터링 중 오류 발생:", error);
                    resultsDiv.innerHTML = '<p style="color: red; text-align: center;">필터링 중 오류가 발생했습니다.</p>';
                } finally {
                    resultsDiv.classList.remove('filtering');
                    if (window.tsParticles && window.tsParticles.domItem(0)) {
                        window.tsParticles.domItem(0).play();
                    }
                }
            }, 50); // 약간의 지연 시간 부여
        }


        function getSelectedCharacterSum(luaString) {
            // 이 함수는 현재 사용되지 않는 것으로 보임, 필요시 로직 검토
            const chars = luaString.match(/.{1,3}/g) || [];
            let sum = 0;
            chars.forEach(char => {
                const code = char.slice(0, 2); // 코드 추출
                const num = parseInt(char[2]);
                const box = [...document.getElementsByClassName('character-box')]
                    .find(b => b.dataset.engName.startsWith(code)); // engName으로 비교
                if (box && box.classList.contains('selected')) {
                    sum += num;
                }
            });
            return sum;
        }

        function checkConditions(chars) {
            const count = {};
            chars.forEach(c => {
                const code = c.slice(0,2); // 코드 추출
                const num = parseInt(c[2]);
                count[code] = (count[code]||0)+num;
            });

            // 모든 캐릭터 박스를 순회하며 선택된 캐릭터의 조건 확인
            const selectedBoxes = document.querySelectorAll('.character-box.selected');
            if (selectedBoxes.length === 0) return true; // 아무것도 선택 안했으면 모든 아이템 표시

            for (const box of selectedBoxes) {
                const engName = box.dataset.engName;
                const requiredCount = parseInt(box.querySelector('input').value);
                const code = engName.slice(0, 2); // 캐릭터 코드 추출
                const currentCount = count[code] || 0; // 해당 캐릭터의 개수

                if (currentCount < requiredCount) {
                    return false; // 하나라도 조건 미달이면 false 반환
                }
            }

            return true; // 모든 선택된 캐릭터의 조건을 만족하면 true 반환
        }

        function optimizeImages() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                if (!img.hasAttribute('loading')) img.loading = 'lazy';
                if (!img.hasAttribute('decoding')) img.decoding = 'async';
            });

            // 사전 로딩은 초기 로딩 속도에 영향을 줄 수 있으므로,
            // 정말 중요한 이미지(예: 첫 화면에 보이는 캐릭터)만 제한적으로 사용 권장
            // const imagesToPreload = new Set();
            // characters.slice(0, 5).forEach(([_, name]) => {
            //     imagesToPreload.add(`Portrait/${name}.png`);
            // });
            // preloadImages(imagesToPreload);
        }

        // function preloadImages(imageSet) {
        //     const imagePromises = Array.from(imageSet).map(src => {
        //         return new Promise((resolve) => { // 에러 발생 시에도 resolve
        //             const img = new Image();
        //             img.decoding = 'async';
        //             img.onload = resolve;
        //             img.onerror = resolve;
        //             img.src = src;
        //         });
        //     });
        //     return Promise.all(imagePromises);
        // }

        function displayResults(data) {
            const res = document.getElementById('results');
            res.scrollTop = 0;

            if (res.scrollHandler) {
                res.removeEventListener('scroll', res.scrollHandler);
                res.scrollHandler = null; // 핸들러 참조 제거
            }

            const fragment = document.createDocumentFragment();
            const container = document.createElement('div');
            container.className = 'content-container';
            fragment.appendChild(container);

            const sortedKeys = Object.keys(data); // 이미 filterData에서 정렬됨

            if (sortedKeys.length === 0) {
                 container.innerHTML = '<p style="text-align: center; margin-top: 30px; color: #aaa;">선택한 조건을 만족하는 아이템이 없습니다.</p>';
                 res.innerHTML = '';
                 res.appendChild(fragment);
                 document.getElementById('copyInstruction').style.display = 'none'; // 안내 문구 숨김
                 return; // 결과 없으면 종료
            }


            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const dataSrc = img.getAttribute('data-src');
                        if (dataSrc) {
                            img.src = dataSrc;
                            img.removeAttribute('data-src');
                        }
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.01
            });

            sortedKeys.forEach(k => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.dataset.itemKey = k;
                const itemDetails = itemDetailsMap[k];
                if (!itemDetails) return; // 아이템 상세 정보 없으면 건너뛰기

                item.dataset.rareSignature = itemDetails.rareSignature || '';
                const charValue = data[k];

                const txt = document.createElement('div');
                txt.className = 'result-text';

                // displayText 사용, 가격, 키 추가
                txt.innerHTML = `<span class="item">${itemDetails.displayText || '정보 없음'}</span>
                                 <span class="price">$${itemDetails.price?.toFixed(2) ?? '?.??'}</span>
                                 <span class="key">(${k})</span>`;
                item.appendChild(txt);

                const imgs = document.createElement('div');
                imgs.className = 'item-images';

                // 캐릭터 이미지 추가
                const charPattern = /([a-z]{2})(\d)/g;
                let match;
                while ((match = charPattern.exec(charValue)) !== null) {
                    const code = match[1];
                    const count = parseInt(match[2]);
                    const charInfo = characters.find(([eng]) => eng.startsWith(code));
                    if (charInfo) {
                        const korName = charInfo[1];
                        const isRare = rareCharacters.some(([rareEng]) => rareEng.startsWith(code));
                        for (let i = 0; i < count; i++) {
                            const img = document.createElement('img');
                            img.setAttribute('data-src', `Portrait/${korName}.png`);
                            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                            img.alt = korName;
                            img.className = 'small-character-img';
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            if (isRare) img.classList.add('rare');
                            imgs.appendChild(img);
                            imageObserver.observe(img);
                        }
                    }
                }

                // 파파샤 이미지 추가 (하드코딩된 부분 - 필요시 데이터 기반으로 변경)
                const papashaInfo = characters.find(([eng]) => eng === 'papasha');
                if (papashaInfo) {
                    const papashaImg = document.createElement('img');
                    papashaImg.setAttribute('data-src', `Portrait/${papashaInfo[1]}.png`);
                    papashaImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    papashaImg.alt = papashaInfo[1];
                    papashaImg.className = 'small-character-img';
                    papashaImg.loading = 'lazy';
                    papashaImg.decoding = 'async';
                    imgs.appendChild(papashaImg);
                    imageObserver.observe(papashaImg);
                }


                // 아이템 박스 추가 (PTicket)
                if (itemDetails.gemsCount) {
                    const gemsBox = document.createElement('div');
                    gemsBox.className = 'item-box';
                    // "PTicket" 대신 "픽업 티켓"으로 표시
                    gemsBox.innerHTML = `<div class="item-title">픽업 티켓</div><div class="item-count">${itemDetails.gemsCount}</div>`;
                    imgs.appendChild(gemsBox);
                }

                // 아이템 박스 추가 (Guaranteed)
                if (itemDetails.guaranteed) {
                    const guaranteedBox = document.createElement('div');
                    guaranteedBox.className = 'item-box';
                    // "Pickup", "Guaranteed" 대신 "픽업", "확정"으로 표시
                    guaranteedBox.innerHTML = `<div class="item-title">픽업</div><div class="item-count">확정</div>`;
                    imgs.appendChild(guaranteedBox);
                }

                item.appendChild(imgs);
                item.addEventListener('click', () => showSimilarItems(item));
                container.appendChild(item);
            });

            res.innerHTML = '';
            res.appendChild(fragment);
            document.getElementById('copyInstruction').style.display = 'block'; // 결과 있으면 안내 문구 표시

            res.scrollHandler = function() {
                const now = performance.now();
                 if (!res.isScrolling) {
                     res.isScrolling = true;
                     res.classList.add('scrolling');
                     document.body.classList.add('is-scrolling');
                 }
                 clearTimeout(res.scrollEndTimer);
                 res.scrollEndTimer = setTimeout(function() {
                     res.isScrolling = false;
                     res.classList.remove('scrolling');
                     document.body.classList.remove('is-scrolling');
                 }, 100);
            };
            res.addEventListener('scroll', res.scrollHandler, { passive: true });
        }


        function showSimilarItems(item) {
            const itemKey = item.dataset.itemKey;
            const rareSignature = item.dataset.rareSignature;
            const itemDetails = itemDetailsMap[itemKey]; // 현재 아이템 정보

            if (!itemDetails) return; // 정보 없으면 중단

            // 시그니처 없거나, 동일 시그니처 아이템이 1개 이하일 때 바로 복사
            if (!rareSignature || rareSignature === '') {
                copyToClipboard(item);
                return;
            }

            const similarItems = Array.from(document.querySelectorAll('.result-item'))
                                    .filter(otherItem => otherItem.dataset.rareSignature === rareSignature);

            if (similarItems.length <= 1) {
                copyToClipboard(item);
                return;
            }


            if (window.tsParticles && window.tsParticles.domItem(0)) {
                window.tsParticles.domItem(0).pause();
            }

            const popupItemsContainer = document.getElementById('signaturePopupItems');
            popupItemsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const popupTitle = document.querySelector('.signature-popup-title');

            // 팝업 제목 한국어화 및 시그니처 포함
            popupTitle.textContent = `동일 한정 캐릭터 세트 (${formatRareSignature(rareSignature)}) 포함 아이템`;

            const popupImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const dataSrc = img.getAttribute('data-src');
                        if (dataSrc) {
                            img.src = dataSrc;
                            img.removeAttribute('data-src');
                        }
                        observer.unobserve(img);
                    }
                });
            }, {
                root: document.getElementById('signaturePopup'), // 팝업 내부 스크롤 기준
                rootMargin: '100px 0px',
                threshold: 0.01
            });

            // 유사 아이템들 정렬 (가격 내림차순)
             similarItems.sort((a, b) => {
                const priceA = itemDetailsMap[a.dataset.itemKey]?.price ?? 0;
                const priceB = itemDetailsMap[b.dataset.itemKey]?.price ?? 0;
                return priceB - priceA;
            });


            similarItems.forEach(similarItem => {
                const similarItemKey = similarItem.dataset.itemKey;
                const similarItemDetails = itemDetailsMap[similarItemKey];
                if (!similarItemDetails) return; // 상세 정보 없으면 건너뛰기

                const charValue = luaData[similarItemKey];
                const popupItem = document.createElement('div');
                popupItem.className = 'signature-popup-item';
                popupItem.dataset.itemKey = similarItemKey;


                const txt = document.createElement('div');
                txt.className = 'result-text';
                // displayText 사용, 가격, 키 추가
                txt.innerHTML = `
                    <span class="item">${similarItemDetails.displayText || '정보 없음'}</span>
                    <span class="price">$${similarItemDetails.price?.toFixed(2) ?? '?.??'}</span>
                    <span class="key" style="color: orange;">(${similarItemKey})</span>`;
                popupItem.appendChild(txt);

                const imgs = document.createElement('div');
                imgs.className = 'item-images';

                // 캐릭터 이미지 로직 (displayResults와 동일하게 적용)
                const charPattern = /([a-z]{2})(\d)/g;
                let match;
                 while ((match = charPattern.exec(charValue)) !== null) {
                     const code = match[1];
                     const count = parseInt(match[2]);
                     const charInfo = characters.find(([eng]) => eng.startsWith(code));
                     if (charInfo) {
                         const korName = charInfo[1];
                         const isRare = rareCharacters.some(([rareEng]) => rareEng.startsWith(code));
                         for (let i = 0; i < count; i++) {
                             const img = document.createElement('img');
                             img.setAttribute('data-src', `Portrait/${korName}.png`);
                             img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                             img.alt = korName;
                             img.className = 'small-character-img';
                             img.loading = 'lazy';
                             img.decoding = 'async';
                             if (isRare) img.classList.add('rare');
                             imgs.appendChild(img);
                             popupImageObserver.observe(img);
                         }
                     }
                 }

                 // 파파샤 이미지 추가 (displayResults와 동일하게 적용)
                 const papashaInfo = characters.find(([eng]) => eng === 'papasha');
                 if (papashaInfo) {
                     const papashaImg = document.createElement('img');
                     papashaImg.setAttribute('data-src', `Portrait/${papashaInfo[1]}.png`);
                     papashaImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                     papashaImg.alt = papashaInfo[1];
                     papashaImg.className = 'small-character-img';
                     papashaImg.loading = 'lazy';
                     papashaImg.decoding = 'async';
                     imgs.appendChild(papashaImg);
                     popupImageObserver.observe(papashaImg);
                 }


                 // 아이템 박스 추가 (PTicket) - 한국어 적용
                 if (similarItemDetails.gemsCount) {
                     const gemsBox = document.createElement('div');
                     gemsBox.className = 'item-box';
                     gemsBox.innerHTML = `<div class="item-title">픽업 티켓</div><div class="item-count">${similarItemDetails.gemsCount}</div>`;
                     imgs.appendChild(gemsBox);
                 }

                 // 아이템 박스 추가 (Guaranteed) - 한국어 적용
                 if (similarItemDetails.guaranteed) {
                     const guaranteedBox = document.createElement('div');
                     guaranteedBox.className = 'item-box';
                     guaranteedBox.innerHTML = `<div class="item-title">픽업</div><div class="item-count">확정</div>`;
                     imgs.appendChild(guaranteedBox);
                 }

                popupItem.appendChild(imgs);


                if (similarItemKey === itemKey) {
                    popupItem.style.border = '2px solid #ff4081'; // 현재 클릭된 아이템 강조
                    popupItem.style.backgroundColor = 'rgba(255, 64, 129, 0.1)';
                }

                popupItem.addEventListener('click', () => {
                    copyToClipboard(similarItem); // 주의: similarItem은 DOM 요소임
                    closeSignaturePopup();
                });

                fragment.appendChild(popupItem);
            });

            popupItemsContainer.appendChild(fragment);

            const popup = document.getElementById('signaturePopup');
            const overlay = document.getElementById('overlay');
            overlay.classList.add('show'); // 오버레이 먼저 표시
            popup.scrollTop = 0; // 스크롤 초기화

            // 강제 리플로우 후 애니메이션 시작 (더 부드러운 등장)
            void popup.offsetWidth;
            popup.classList.add('show');

        }

        function formatRareSignature(signature) {
            if (!signature) return '';
            const charPattern = /([a-z]{2})(\d)/g;
            let match;
            let result = [];
            while ((match = charPattern.exec(signature)) !== null) {
                const code = match[1];
                const count = match[2];
                // rareCharacters에서 영어 이름 찾아 사용 (영어 이름이 더 익숙할 수 있음)
                const charInfo = rareCharacters.find(([eng]) => eng.startsWith(code));
                // 또는 한국어 이름 사용: const charInfo = characters.find(([eng]) => eng.startsWith(code));
                if (charInfo) {
                     result.push(`${charInfo[0]}${count}`); // 영어 이름 + 개수
                    // result.push(`${charInfo[1]}${count}`); // 한국어 이름 + 개수 (선택)
                } else {
                    result.push(`${code}${count}`); // 이름 못 찾으면 코드 사용
                }
            }
            return result.join(', '); // 쉼표와 공백으로 구분
        }

        function closeSignaturePopup() {
            const popup = document.getElementById('signaturePopup');
            const overlay = document.getElementById('overlay');
            popup.classList.remove('show');
            overlay.classList.remove('show');

            // 애니메이션 끝난 후 파티클 재개 및 display none
            popup.addEventListener('transitionend', () => {
                 if (!popup.classList.contains('show')) { // 닫힐 때만 실행
                    if (window.tsParticles && window.tsParticles.domItem(0)) {
                        window.tsParticles.domItem(0).play();
                    }
                 }
            }, { once: true }); // 이벤트 리스너 한 번만 실행
        }

        document.getElementById('signaturePopupClose').addEventListener('click', closeSignaturePopup);
        document.getElementById('overlay').addEventListener('click', closeSignaturePopup);
        // ESC 키로 팝업 닫기 (선택사항)
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('signaturePopup').classList.contains('show')) {
                closeSignaturePopup();
            }
        });

        function formatCharacterString(charString) {
            // 이 함수는 현재 사용되지 않는 것으로 보임, 필요시 로직 검토/한글화
            let result = [];
            const charPattern = /([a-z]{2})(\d)/g;
            let match;
            while ((match = charPattern.exec(charString)) !== null) {
                const code = match[1];
                const count = match[2];
                const charInfo = characters.find(([eng]) => eng.startsWith(code));
                if (charInfo) {
                    const korName = charInfo[1]; // 한국어 이름 사용
                    result.push(`${korName}${count}`);
                } else {
                    result.push(`${code}${count}`);
                }
            }
            return result.join(' ');
        }

        function copyToClipboard(el) {
            const itemKey = el.dataset.itemKey; // DOM 요소에서 키 가져오기
            const itemDetails = itemDetailsMap[itemKey];
            if (!itemDetails || !itemDetails.originalText) {
                 console.error('복사할 원본 텍스트를 찾을 수 없습니다:', itemKey);
                 // 사용자에게 알림 (선택사항)
                 // showCopyMessage("복사 실패", true);
                 return;
            }

            const originalText = itemDetails.originalText;

            navigator.clipboard.writeText(originalText).then(
                () => {
                    console.log('Copied:', originalText);
                    showCopyMessage("복사 완료!"); // 성공 메시지 표시
                 },
                err => {
                    console.error('클립보드 복사 실패: ', err);
                    showCopyMessage("복사 실패", true); // 실패 메시지 표시
                }
            );
        }

        // 메시지 내용과 에러 여부를 받을 수 있도록 수정
        function showCopyMessage(message = "복사됨", isError = false){
            const msg = document.getElementById('copyMessage');
            const span = msg.querySelector('span');
            const iconDiv = msg.querySelector('.copy-icon');

            span.textContent = message; // 메시지 내용 설정
            if (isError) {
                msg.style.borderLeftColor = 'red'; // 에러 시 색상 변경
                iconDiv.style.backgroundColor = 'red'; // 아이콘 색상 변경 (선택사항)
            } else {
                msg.style.borderLeftColor = '#ff4081'; // 기본 색상
                iconDiv.style.backgroundColor = '#ff4081'; // 기본 색상
            }

            // 애니메이션 클래스 관리
            msg.classList.remove('show'); // 혹시 남아있을 수 있는 클래스 제거
            void msg.offsetWidth; // 리플로우 강제
            msg.classList.add('show');

            // 기존 타이머 제거
            if (msg.hideTimer) {
                clearTimeout(msg.hideTimer);
            }
            // 새 타이머 설정
            msg.hideTimer = setTimeout(() => {
                msg.classList.remove('show');
                msg.hideTimer = null; // 타이머 ID 제거
            }, 2000);
        }

        function getSelectedCharacters(){
            // 선택된 캐릭터 정보 문자열 생성 (분석용)
            return [...document.querySelectorAll('.character-box.selected')]
                .map(b => {
                    const engName = b.dataset.engName;
                    const korName = b.dataset.korName;
                    const value = b.querySelector('input').value;
                    return `${korName}(${engName}):${value}`; // 예: 클루카이(klukai):1
                })
                .join(', ');
        }

        function throttle(func, delay) {
            let lastCall = 0;
            let timeoutId = null;
            return function(...args) {
                const now = Date.now();
                const context = this;
                if (now - lastCall >= delay) {
                    lastCall = now;
                    func.apply(context, args);
                } else {
                     // 마지막 호출 후 delay 내에 다시 호출되면, 타이머 설정하여 delay 후에 실행
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                         lastCall = Date.now();
                         func.apply(context, args);
                    }, delay - (now - lastCall));
                }
            };
        }

        const throttledFilterHandler = throttle(function() {
            // 결과 영역이 화면에 보이도록 스크롤 (부드럽게)
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // 데이터 로드 및 필터링 실행
            // loadData()는 최초 로드 시 한 번만 필요할 수 있음. 필터링만 실행하도록 변경 고려
             // filterData(); // 데이터가 이미 로드되었다고 가정
             // 또는 필요 시 loadData() 다시 호출
             loadData().then(() => { // 데이터 갱신이 필요할 경우
                filterData();
                // 분석 이벤트 전송 (선택된 캐릭터 정보 포함)
                const selectedInfo = getSelectedCharacters();
                if (selectedInfo) { // 선택된 것이 있을 때만 전송
                    gtag('event', 'apply_filter', {
                        'selected_characters': selectedInfo
                    });
                }
             }).catch(error => {
                console.error('필터 적용 중 데이터 로드 에러:', error);
             });
        }, 500); // 500ms 쓰로틀링 (조절 가능)

        document.getElementById('filterButton').addEventListener('click', throttledFilterHandler);

        document.addEventListener('visibilitychange', () => {
            if (window.tsParticles && window.tsParticles.domItem(0)) {
                if (document.visibilityState === 'hidden') {
                    window.tsParticles.domItem(0).pause();
                } else {
                    window.tsParticles.domItem(0).play();
                }
            }
        });

        // 터치 이벤트 클래스 추가/제거 (스타일링용)
        document.addEventListener('touchstart', () => {
            document.body.classList.add('touch-active');
        }, { passive: true });
        document.addEventListener('touchend', () => {
             // 약간의 지연 후 제거 (클릭 효과 등)
            setTimeout(() => {
                document.body.classList.remove('touch-active');
            }, 100);
        }, { passive: true });

        // 디바운스 리사이즈 핸들러 (필요 시 사용)
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        const debouncedResizeHandler = debounce(() => {
            // 리사이즈 시 처리할 내용 (예: 레이아웃 재계산)
            console.log("Window resized");
        }, 250);
        window.addEventListener('resize', debouncedResizeHandler, { passive: true });

    </script>
</body>
</html>
